{template nheader.html}
<script type="text/javascript">
$(function() {
	$(".table-list td").last().css('border-bottom','1px solid #EEEEEE');
});
function dr_module_export(url) {
	var throughBox = $.dialog.through;
	var dr_Dialog = throughBox({title: "生成须知"});
	dr_Dialog.content('<div style="padding:10px 20px"><li style="line-height:27px;list-style:none;">1、将当前模块生成新的字段配置文件</li><li style="line-height:27px;list-style:none;">2、新模块含自定义字段，不含栏目和数据</li><li style="line-height:27px;list-style:none;">3、原config目录数据将备份为_config目录</li><li style="line-height:27px;color:red;list-style:none;">4、当前模块目录必须有可写权限，否则无法创建</li><li style="line-height:45px;list-style:none;">模块新名称： <input id="dr_module_new_name" class="input-text" type="text" style="width:145px;height:28px" /></li></div>');
	dr_Dialog.button({name: "下一步", callback:function() {
			var win = $.dialog.top;
			var name = win.$("#dr_module_new_name").val();
			location.href = url+"&name="+name;
		},
		focus: true
	});
}
function dr_copy_module(url) {
	var throughBox = $.dialog.through;
	var dr_Dialog = throughBox({title: "{L('创建/复制模块')}"});
	$.ajax({type: "GET", url:url, dataType:'text', success: function (text) {
			var win = $.dialog.top;
			dr_Dialog.content(text);
			dr_Dialog.button({name: "{L('执行')}", callback:function() {
					win.$("#mark").val("0"); // 标示可以提交表单
					if (win.dr_form_check()) { // 按钮返回验证表单函数
						var _data = win.$("#myform").serialize();
						$.ajax({type: "POST",dataType:"json", url: url, data: _data, // 将表单数据ajax提交验证
							success: function(res) {
								if (res.code) {
									dr_tips(res.msg, 3, 1); 
									setTimeout("window.location.reload(true)", 3000);
								} else {
									dr_tips(res.msg, 5); 
									return true;
								}
							},
							error: function(HttpRequest, ajaxOptions, thrownError) {
								alert(HttpRequest.responseText);
							}
						});
					}
					return false;
				},
				focus: true
			});
	    },
	    error: function(HttpRequest, ajaxOptions, thrownError) {
			alert(HttpRequest.responseText);
		}
	});
}
</script>
<style>
.dr_none td {background-color: #f8f8f8;}
</style>
<div class="page-bar">
	<ul class="page-breadcrumb mylink">
		{$menu.link}
	</ul>
	<ul class="page-breadcrumb myname">
		{$menu.name}
	</ul>
	<div class="page-toolbar">
		<div class="btn-group pull-right">
			<button type="button" class="btn green btn-sm btn-outline dropdown-toggle" data-toggle="dropdown" aria-expanded="false" data-hover="dropdown"> {L('操作菜单')}
				<i class="fa fa-angle-down"></i>
			</button>
			<ul class="dropdown-menu pull-right" role="menu">
				{loop $menu.quick $t}
				<li>
					<a href="{$t.url}">{$t.icon} {$t.name}</a>
				</li>
				{/loop}
				<li class="divider"> </li>
				<li>
					<a href="javascript:window.location.reload();">
						<i class="icon-refresh"></i> {L('刷新页面')}</a>
				</li>
			</ul>
		</div>
	</div>
</div>
<h3 class="page-title">
	<small>{L('独立模块栏目为独立化设计，每个模块拥有不同的栏目')}</small>
</h3>

<form class="form-horizontal" action="" method="post" id="myform" name="myform">
	<div class="portlet mylistbody">
		<div class="portlet-body">
			<div class="table-scrollable">

				<table class="mytable table table-striped table-bordered table-hover table-checkable dataTable">

					<thead>
					<tr>
						<th width="100" align="left">{L('类型')}</th>
						<th width="200" align="left">{L('名称')}</th>
						<th width="200" align="left">{L('目录')}</th>
						<th width="100" align="left">{L('站点')}</th>
						<th width="100" align="left">{L('版本')}</th>
						<th width="100" align="left">{L('可用')}</th>
						<th align="left" class="dr_option">{L('操作')}</th>
					</tr>
					</thead>
					<tbody>
					{loop $list[1] $dir $t}
					<tr>
						<td align="left">
							
						</td>
						<td align="left">{$t.name}</td>
						<td align="left">{$dir}</td>
						<td align="left">{if $t.space}{else}<a href="{dr_url('module/site', array('id'=>$t.id))}">{count($t.site)}</a>{/if}</td>
						<td align="left">{$t.version}</td>
						<td align="left">{if $this->ci->is_auth('module/edit') && !$t.space}<a href="javascript:;" onClick="return dr_dialog_set('{php echo $t.disabled ? L('<font color=blue><b>你确定要启用它？启用后将正常使用</b></font>') : L('<font color=red><b>你确定要禁用它？禁用后将无法使用</b></font>');}','{dr_url('module/disabled',array('id'=>$t.id))}');"><img src="{THEME_PATH}admin/images/{php echo $t.disabled ? 0 : 1}.gif"></a>{else}<img src="{THEME_PATH}admin/images/{php echo $t.disabled ? 0 : 1}.gif"></a>{/if}</td>

						<td align="left" class="dr_option">
							{if !$t.space}
								{if $this->ci->is_auth('module/config')}<a class="ago" href="{dr_url('module/config',array('id'=>$t.id, 'all' => 1))}"> <i class="fa fa-cog"></i> {L('配置')}</a>{/if}
								{if $this->ci->is_auth('module/site')}<a class="alist" href="{dr_url('module/site', array('id'=>$t.id))}" style="color:green"> <i class="fa fa-cubes"></i> {L('站点管理')}</a>{/if}
								{if !$t.nodb}
									{if $this->ci->is_auth('module/config')}<a class="ago" href="javascript:;" onclick="dr_copy_module('{dr_url('module/copy',array('dir'=>$dir))}')"> <i class="fa fa-copy"></i> {L('复制')}</a>{/if}
									{if SYS_DEBUG}<a class="alist" href="javascript:;" onclick="dr_module_export('{dr_url('module/export',array('dir'=>$dir))}')"> <i class="fa fa-share-square-o"></i> {L('生成')}</a>{/if}
									{if $this->ci->is_auth('admin/field/index')}<a class="aadd" href="{php echo $duri->uri2url('admin/field/index/rname/module/rid/'.$t.id);}"> <i class="fa fa-plus-square"></i> {L('模块字段')}</a>{/if}
									{if $t.extend && $this->ci->is_auth('admin/field/index')}<a class="aadd" href="{php echo $duri->uri2url('admin/field/index/rname/extend/rid/'.$t.id);}"> <i class="fa fa-plus-circle"></i> {L('扩展字段')}</a>{/if}
								{/if}
							{else}
								{if $this->ci->is_auth('module/config')}<a class="ago" href="{dr_url('space/setting/space')}"> <i class="fa fa-cog"></i> {L('配置')}</a>{/if}
							{/if}
							{if $this->ci->is_auth('module/uninstall')}<a class="adel" href="javascript:;" onClick="return dr_confirm_url('<font color=red><b>{L('该操作将会删除全部站点中的模块内容数据，您确定吗？')}</b></font>','{dr_url('module/uninstall',array('id'=>$t.id))}');"> <i class="fa fa-trash"></i> {L('卸载')}</a>{/if}
							{if !$t['site'][SITE_ID]['use'] && !$t.space}<a style="color:red" href="{dr_url('module/install', array('id'=>$t.id))}">[{L('当前站点尚未安装')}]</a>{/if}

							<span id="dr_domain_{$dir}"></span>
							<script type="text/javascript">
								{loop $t.site $s}
								{if $s.domain}
									$.get("{dr_url('home/domain', array('domain' => $s.domain))}", function(data){
										if (data) {
											$("#dr_domain_{$dir}").html("<a href='{dr_url('module/install',array('id'=>$t.id))}' style='color:red;'>域名解析异常</a>");
										}
									});
									{/if}
										{/loop}
							</script>
						</td>
					</tr>
					{/loop}
					{loop $list[0] $dir $t}
					{if !in_array($dir, ['base'])}
					<tr class="dr_none">
						<td align="left"></td>
						<td align="left">{$t.name}</td>
						<td align="left">{$dir}</td>
						<td align="left">0</td>
						<td align="left">{$t.version}</td>
			            <td align="left">
							{if $this->ci->is_auth('module/install')}
								<a href="javascript:void(0);" onclick="dr_install_share('内容模块有各自的主表和栏目表,相互无关联,完全独立化管理,负载能力极高', '{dr_url('module/install_all', array('dir'=>$dir))}')" style="color:#00F">
							{else}
								<a href="javascript:;" style="color:#999">
							{/if}
							{L('安装')}</a>
						</td>
						<td align="left" class="dr_option">
							{if $admin.adminid == 1}<a class="adel" href="javascript:;" onClick="return dr_confirm_url('<font color=red><b>{L('该操作将会从磁盘中彻底删除它且数据不可恢复，您确定吗？')}</b></font>','{dr_url('module/delete',array('dir'=>$dir))}');" style="color:#F00"> <i class="fa fa-close"></i> {L('删除')}</a>{/if}
						</td>
					</tr>
					{/if}
					{/loop}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</form>
{template nfooter.html}